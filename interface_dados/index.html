<!DOCTYPE html>
<html lang="pt-br">
  <meta charset="utf-8" />
  <head>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Detectando na Água</title>

    <script src="https://www.gstatic.com/firebasejs/4.8.1/firebase.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <link rel="stylesheet" type="text/css" href="styles.css" />
  </head>
  <body>
    <h2>Gráficos de condutividade</h2>
    <div id="chart" class="container"></div>
    <div id="spline" class="container"></div>

    <script src="https://code.highcharts.com/highcharts.js"></script>
    <script src="https://code.highcharts.com/modules/exporting.js"></script>
    <script src="https://code.highcharts.com/modules/export-data.js"></script>
    <script src="https://code.highcharts.com/modules/accessibility.js"></script>
    <script src="https://www.gstatic.com/firebasejs/4.8.1/firebase.js"></script>

    <script>
      let chart;
      const firebaseConfig = {
        //credenciais do Firebase
        apiKey: "AIzaSyDIaOpxMeNXLAZOS8nOYpdEUYhcTwLayC0",
        authDomain: "detectando-na-agua1.firebaseapp.com",
        databaseURL: "https://detectando-na-agua1-default-rtdb.firebaseio.com",
        projectId: "detectando-na-agua1",
        storageBucket: "detectando-na-agua1.appspot.com",
        messagingSenderId: "665441693882",
        appId: "1:665441693882:web:f4a523216afe48fd3e9283",
        measurementId: "G-0NB4FVB0DQ"
      };
      firebase.initializeApp(firebaseConfig); //configura as credenciais do banco de dados

      var db = firebase.database(); //inicializa o banco de dados

      window.addEventListener("load", function() {
        chart = new Highcharts.Chart({
          //Estrutura responsavel por determinar os dados do gráfico
          chart: { renderTo: "chart" },
          title: { text: "Gráfico 01" },
          events: {
            load: requestFB()
          },
          series: [
            {
              color: "#059e8a",
              showInLegend: true,
              name: "Umidade do Solo",
              data: [0, 1] //parte responsavel por plotar pontos(manualmente)dos dados
            },
            {
              color: "#9B111E",
              showInLegend: true,
              name: "Temperatura do Ar",
              data: [0, 1]
            }
          ],
          plotOptions: {
            line: {
              animation: true,
              dataLabels: { enabled: true }
            }
          },
          xAxis: {
            type: "datetime",
            dateTimeLabelFormats: { second: "%H:%M:%S" }
          },
          yAxis: {
            title: { text: "Umidade(%) e Temperatura(°C)" }
          },
          credits: { enabled: false }
        });
        spline = new Highcharts.Chart({
          //Estrutura responsavel por determinar os dados do gráfico
          chart: {
            type: 'spline',
            renderTo: "spline",
            scrollablePlotArea: {
              minWidth: 600,
              scrollPositionX: 1
            }
          },
          title: { text: "Gráfico 02" },
          events: {
            load: requestFB()
          },
          series: [
            {
              color: "#059e8a",
              showInLegend: true,
              name: "Umidade do Solo",
              data: [ 3.7, 3.3, 3.9, 5.1, 3.5, 3.8, 4.0, 5.0, 6.1, 3.7, 3.3, 6.4,
            6.9, 6.0, 6.8, 4.4, 4.0, 3.8, 5.0, 4.9, 9.2, 9.6, 9.5, 6.3,
            9.5, 10.8, 14.0, 11.5, 10.0, 10.2, 10.3, 9.4, 8.9, 10.6, 10.5, 11.1,
            10.4, 10.7, 11.3, 10.2, 9.6, 10.2, 11.1, 10.8, 13.0, 12.5, 12.5, 11.3,
            10.1] //parte responsavel por plotar pontos(manualmente)dos dados
            },
            {
              color: "#9B111E",
              showInLegend: true,
              name: "Temperatura do Ar",
              data: [0.2, 0.1, 0.1, 0.1, 0.3, 0.2, 0.3, 0.1, 0.7, 0.3, 0.2, 0.2,
            0.3, 0.1, 0.3, 0.4, 0.3, 0.2, 0.3, 0.2, 0.4, 0.0, 0.9, 0.3,
            0.7, 1.1, 1.8, 1.2, 1.4, 1.2, 0.9, 0.8, 0.9, 0.2, 0.4, 1.2,
            0.3, 2.3, 1.0, 0.7, 1.0, 0.8, 2.0, 1.2, 1.4, 3.7, 2.1, 2.0,
            1.5]
            }
          ],
          plotOptions: {
            spline: {
              lineWidth: 4,
              states:{
                hover:{
                  lineWidth: 5
                }
              },
              animation: true,
              dataLabels: { enabled: true },
              
            }
          },
          xAxis: {
            type: "datetime",
            dateTimeLabelFormats: { second: "%H:%M:%S" },
            labels: {
              overflow: "justify"
            }
          },
          yAxis: {
            title: { text: "Umidade(%) e Temperatura(°C)" },
            minorGridLineWidth: 0,
            gridLineWidth: 0,
            alternateGridColor: null,
          },
          credits: { enabled: false }
        });

        async function requestFB() {
          db.ref("teste/solo")
            .limitToLast(1)
            .on("value", snapshot => {
              var EIXO_X = new Date();
              snapshot.forEach(childSnapshot => {
                if (chart.series[0].data.length > 25) {
                  //exibe 10 pontos na area do grafico
                  chart.series[0].addPoint(
                    [EIXO_X, childSnapshot.val()],
                    true,
                    true
                  );
                } else {
                  chart.series[0].addPoint(
                    [EIXO_X, childSnapshot.val()],
                    true,
                    false
                  ); //apaga o ponto mais antigo do gráfico
                }
              });
            });
        }
      });
    </script>
  </body>
</html>
